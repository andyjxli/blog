---
layout: post
title: project_rewrite
image: img/xiyizhou.jpg
author: xilizi
date: 2019-03-10T10:00:00.000Z
draft: false
tags:
  - Time
category: { title: '前端', name: 'frontend' }
---

<center><h1>推广流程重构总结</h1></center>

## 背景

加入多多已经有了将近 6 个月的时间，主要负责多多进宝推手端项目。推手端网站的项目大致可以分为 3 个模块：

### 1. 实名认证流程

最开始接触进宝项目时，这个模块的代码还在老的项目中。为了快速熟悉进宝的项目，并且熟悉 React，所以将老代码迁移过来的任务就落在我的身上了。这个时期只能用 React 写一些的业务代码。

### 2. 数据效果展示模块

数据效果展示模块分为很多种类。主要是为了展示推广的数据给推手看，这部分的业务并不复杂，主要是通过一些组件来展示一些数据。这个时期对 React 开始有了认识，对代码以及性能的要求也开始加强。并且基于现有场景，抽象出一些更加通用的业务组件。

### 3. 推手分享模块

推手分享的模块主要是为了让推手能够生成推广链接，从而对商品进行推广。而在这之间，产品推出了短信推广模块。由于这个模块是全新的，而 React 已经推出了 Hooks，于是开始尝试使用 hooks 写业务代码。

## 为什么重构？

### 1. 推广设置新增红包设置

这是起点，在这个需求开始之前，对这块的代码没有详细的看过。觉得这个需求并不是那么复杂。但是在开发过程中比较艰难。大致有以下几点：

- 模块代码全是用 js 写的，写惯了 TS 觉得有些难受，并且无法知道数据类型
- 组件完全自己开发、没有用到 MUI、Beast。
- 组件颗粒度不够细，耦合度较高、不易维护。一个模块有将近 500 行的代码，导致推广设置新增一项、分享链接由一个变成多个时很艰难。
- 代码复用不够。由于推广设置模块在单品推广、店铺推广、精选推广中都有使用，精选推广中又下分 10 个类目。并且每个类目的表现都不同。具体体现在推广设置的选项、接口的请求、生成的分享链接种类等等。所以在老代码中依靠 if、switch 来生成模版，这就会导致大量的重复代码部分模块如图：![](https://user-gold-cdn.xitu.io/2019/6/30/16ba6f5505e505d2?w=1768&h=1644&f=png&s=309314)
- 组件中用 Ref 来调用方法，并且参数已经超过了 6 个，如果未来还有添加项，会无法控制。

### 2.新需求新增设置推广商品模块

在开发完红包自定义需求后，还没上线，新需求接踵而来：为精选推广中三个模块新增新需求新增设置推广商品模块。并且模块的表现不尽相同。有了第一次的痛苦，说不定未来新增的改动更加多。决定不再积累痛苦了，开始了重构之旅。

## 如何重构？

### 1. 提高代码可读性

为了提高代码可读性，使用最新稳定的技术栈

- Hooks
- Typescript
- 接入 Beast

### 2. 拆分组件，提高复用

- 旧模块划分
  ![](https://user-gold-cdn.xitu.io/2019/6/30/16ba717a1d28f255?w=1374&h=776&f=png&s=69926)
- 拆解后![](https://user-gold-cdn.xitu.io/2019/6/30/16ba722b4ca73eeb?w=1306&h=950&f=png&s=88280)
  主要拆解的模块为推广设置模块，每个子组件都是一项可选的组件。与外界无耦合，只需要调用即可。
  而生成链接的模块看似无变化，其实变化挺大。旧的代码是有大量的重复代码，导致两个模块代码加起来将近 1000 行代码。而重构后的代码只有不到 200 行。主要体现在展示模块的代码复用不够、用的全是手写的组件。

### 3. 使用 Hooks 的 useReducer 控制全局

useReducer 为我们提供了 Redux 相似的功能。所以在本次重构中，将 store 的数据统一存储，在各个组件中能够使用，能够解决状态控制的问题。
将 store 拆分为三个模块数据：

- 全局状态数据：控制当前应该展示哪个模块以及当前是属于哪个推广（单品、精选等）下的哪个类目（转盘、红包、手机商城等）。
- 推广设置数据：存储当前设置的数据，在确认设置时能够将数据按照推广类型来统一处理数据，以便请求接口。
- 分享链接数据：存储当前链接类型、单（双）人团等。

### 4. 使用 Map、Symbol 走配置项，提高可扩展性、易维护性

由于类目太多，并且表现不同，如果每个类目在需求变更时只需要在配置文件里改变参数就能达到预期，那不要太爽。所以我将各个类目都统一命名，为每个类目配置好相应的组件名。并且保存在推广设置 Index 的配置文件中。那么外部组件只需要告诉我是什么类目，就能为其渲染出对应的 UI，并且数据都能够统一处理。例如：
![](https://user-gold-cdn.xitu.io/2019/6/30/16ba742278e57df4?w=1540&h=962&f=png&s=161559)
不仅如此，配置文件中的其他配置还能够配置你当前类目所需要的特殊数据，比如需要 title 文案等。
配置文件包含的配置项：

- 配置每个类目需要展示的设置项
- 配置每个类目生成的分享链接的各条文案（每条链接可能有多条文案对应）
- 配置每个类目生成的分享链接需要展示哪些
- 配置每个类目生成的分享链接是否展示单（双）人团、（无）微信入口的按钮。

配置项可以让开发者只需要简单的更改配置就能完成需求，并且可扩展性、维护性都能大大增强

## 重构的效果

目前只将精选推广的全部类目完成了重构。而单品推广、店铺推广由于时间关系，未能接入最新代码。后面会迁移至最新代码。并且只需要少量的改动就能完成效果。

### 1.代码量更少、可读性更强（完全无 any）类型

提高了代码的复用程度、所以减少了代码量
由于使用了团队最新的技术，让其他开发者能够更容易接受

### 2.可维护性、扩展性明显增强

通过重构，如果改动，只需要更少的代码就能实现预期。例如：

- 增加推广设置项，只需在 XXX 设置模块下新增一个模块组件，然后在 Index 中引入，再在配置项中配置就能解决。完全不用更改其他子组件
- 增加链接类型（短链接、长链接）：更改配置文件
- 更改当前类目需要设置的项：更改配置文件
- 更改链接文案：更改配置文件
- 就不一一例举了
  可以看到大部分场景依靠配置文件就能完成，基本不用更改组件内部代码。

### 3. UI 更加美观

接入 Beast，让 UI 更加美观。

## 总结

通过本次重构，自身还是学到了很多的知识：

- 配置本质上就是策略模式。熟练的使用设计模式能够让代码更加易读、易扩展、易维护
- 完成需求前需要考虑的有很多、并不只是完成一个任务，还需要考虑到未来的可行性。尽量减少为未来的自己埋下的坑。思考清楚怎么做再动手
- 以前学过但没有在项目中实践 Redux，现在发现 useReducer 帮我解决了很大的痛点（状态以及数据的维护）
- useMemo、useCallback 能够有效的减少 React 对代码的执行量，从而提高组件的性能。但是需要注意重新执行的时机。特别是 useMemo 能够有效的减少变量重新赋值的次数。
- Map 数据结构简直是利器。enum 在某些场景下更强。
- ts 中的 interface 与 type 需要在合适的时机使用。例如类型 A 只是 B、C、D 类型的其中一个。那么只需要 type A = B | C | D 就行。而 interface 应该在更多的场景下被使用。
- ts 中的 Partial<T>、Readonly<T>应被更广泛的使用
- ......
